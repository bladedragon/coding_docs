# Elasticsearch

## 为什么要使用Elasticsearch?

因为在我们商城中的数据，将来会非常多，所以采用以往的模糊查询，模糊查询前置配置，会放弃索引，导致商品查询是全表扫面，在百万级别的数据库中，效率非常低下，而我们使用ES做一个全文索引，我们将经常查询的商品的某些字段，比如说商品名，描述、价格还有id这些字段我们放入我们索引库里，可以提高查询速度。

### Lucene与ES关系？

1）Lucene只是一个库。想要使用它，你必须使用Java来作为开发语言并将其直接集成到你的应用中，更糟糕的是，Lucene非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。

2）Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。



## 工作原理

当ElasticSearch的节点启动后，它会利用多播(multicast)(或者单播，如果用户更改了配置)寻找集群中的其它节点，并与之建立连接。

![img](https://img2018.cnblogs.com/blog/1415794/201907/1415794-20190707135454295-1099784154.png)

**1）Cluster：集群。**
ES可以作为一个独立的单个搜索服务器。不过，为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。

**2）Node：节点。**
形成集群的每个服务器称为节点。

**3）Shard：分片。**
当有大量的文档时，由于内存的限制、磁盘处理能力不足、无法足够快的响应客户端的请求等，一个节点可能不够。这种情况下，数据可以分为较小的分片。每个分片放到不同的服务器上。
当你查询的索引分布在多个分片上时，ES会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在。即：这个过程对用户来说是透明的。

**4）Replia：副本。**
为提高查询吞吐量或实现高可用性，可以使用分片副本。
副本是一个分片的精确复制，每个分片可以有零个或多个副本。ES中可以有许多相同的分片，其中之一被选择更改索引操作，这种特殊的分片称为主分片。
当主分片丢失时，如：该分片所在的数据不可用时，集群将副本提升为新的主分片。

**5）全文检索。**
全文检索就是对一篇文章进行索引，可以根据关键字搜索，类似于mysql里的like语句。
全文索引就是把内容根据词的意义进行分词，然后分别创建索引，例如”你们的激情是因为什么事情来的” 可能会被分词成：“你们“，”激情“，“什么事情“，”来“ 等token，这样当你搜索“你们” 或者 “激情” 都会把这句搜出来。

### 数据架构

![img](https://img2018.cnblogs.com/blog/1415794/201907/1415794-20190707135543339-1661164577.png)



### 操作

+ GET：获取请求对象的当前状态。 
+ POST：改变对象的当前状态。 
+ PUT：创建一个对象。 
+ DELETE：销毁对象。 
+ HEAD：请求获取对象的基础信息。



### 索引文档

协调节点默认使用文档ID参与计算（也支持通过routing），以便为路由提供合适的分片。

> shard = hash(document_id) % (num_of_primary_shards)

当分片所在的节点接收到来自协调节点的请求后，会将请求写入到`Memory Buffer`，然后定时（默认是每隔1秒）写入到`Filesystem Cache`，这个从`Momery Buffer`到`Filesystem Cache`的过程就叫做`refresh`；

当然在某些情况下，存在`Momery Buffer`和`Filesystem Cache`的数据可能会丢失，ES是通过`translog`的机制来保证数据的可靠性的。其实现机制是接收到请求后，同时也会写入到`translog`中，当`Filesystem cache`中的数据写入到磁盘中时，才会清除掉，这个过程叫做`flush`；

在`flush`过程中，内存中的缓冲将被清除，内容被写入一个新段，段的`fsync`将创建一个新的提交点，并将内容刷新到磁盘，旧的`translog`将被删除并开始一个新的`translog`。

`flush`触发的时机是定时触发（默认30分钟）或者`translog`变得太大（默认为512M）时；

![img](https://upload-images.jianshu.io/upload_images/18688925-25f85761aa023d34.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/558/format/webp)

1. 客户写集群某节点写入数据，发送请求。（如果没有指定路由/协调节点，请求的节点扮演路由节点的角色。）
2. 节点 1 接受到请求后，使用文档_id 来确定文档属于分片 0。请求会被转到另外的节点，假定节点 3。因此分片 0 的主分片分配到节点 3 上。
3. 节点 3 在主分片上执行写操作，如果成功，则将请求并行转发到节点 1和节点 2 的副本分片上，等待结果返回。所有的副本分片都报告成功，节点 3 将向协调节点（节点 1）报告成功，节点 1 向请求客户端报告写入成功。

### 更新和删除文档

删除和更新也都是写操作，但是**Elasticsearch中的文档是不可变**的，因此不能被删除或者改动以展示其变更；

磁盘上的每个段都有一个相应的`.del`文件。当删除请求发送后，文档并没有真的被删除，而是在`.del`文件中被标记为删除。该文档依然能匹配查询，但是会在结果中被过滤掉。当段合并时，在`.del`文件中被标记为删除的文档将不会被写入新段。

在新的文档被创建时，Elasticsearch会为该文档指定一个**版本号**，当执行更新时，旧版本的文档在.del文件中被标记为删除，新版本的文档被索引到一个新段。旧版本的文档依然能匹配查询，但是会在结果中被过滤掉。

### 搜索文档

搜索被执行成一个两阶段过程，我们称之为 `Query Then Fetch`

在**初始查询**阶段时

+ 查询会广播到索引中每一个分片拷贝（主分片或者副本分片）。 每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列。PS：在搜索的时候是会查询Filesystem Cache的，但是有部分数据还在Memory Buffer，所以搜索是近实时的。
+ 每个分片返回各自优先队列中 所有文档的 ID 和排序值 给协调节点，它合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。

接下来就是 **取回阶段**，

+ 协调节点辨别出哪些文档需要被取回并向相关的分片提交多个 GET 请求。每个分片加载并 丰富 文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端。
+ 补充：Query Then Fetch的搜索类型在文档相关性打分的时候参考的是本分片的数据，这样在文档数量较少的时候可能不够准确，DFS Query Then Fetch增加了一个预查询的处理，询问Term和Document frequency，这个评分更准确，但是性能会变差。
+ 补充：Query Then Fetch的搜索类型在文档相关性打分的时候参考的是本分片的数据，这样在文档数量较少的时候可能不够准确，DFS Query Then Fetch增加了一个预查询的处理，询问Term和Document frequency，这个评分更准确，但是性能会变差。

## 分布式

### 集群

#### 如何实现master选举

前提:

+ 只有候选主节点（master：true）的节点才能成为主节点。
+ 最小主节点数（min_master_nodes）的目的是防止脑裂。

 

Elasticsearch 的选主是 ZenDiscovery 模块负责的，主要包含 Ping（节点之间通过这个 RPC 来发现彼此）和 Unicast（单播模块包含一个主机列表以控制哪些节点需要 ping 通）这两部分



对所有可以成为master的节点（node.master: true）根据nodeId字典排序，每次选举每个节点都把自己所知道节点排一次序，然后选出第一个（第0位）节点，暂且认为它是master节点。

如果对某个节点的投票数达到一定的值（可以成为master节点数n/2+1）并且该节点自己也选举自己，那这个节点就是master。否则重新选举一直到满足上述条件。

> 补充：master节点的职责主要包括集群、节点和索引的管理，不负责文档级别的管理；data节点可以关闭http功能。



### 保证读写一致

可以通过**版本号**使用乐观并发控制，以确保新版本不会被旧版本覆盖，由应用层来处理具体的冲突；

另外对于写操作，一致性级别支持`quorum/one/all`，默认为`quorum`，即只有当大多数分片可用时才允许写操作。但即使大多数可用，也可能存在因为网络等原因导致写入副本失败，这样该副本被认为故障，分片将会在一个不同的节点上重建。

对于读操作，可以设置`replication`为`sync`(默认)，这使得操作在主分片和副本分片都完成后才会返回；如果设置`replication`为`async`时，也可以通过设置搜索请求参数`_preference`为`primary`来查询主分片，确保文档是最新版本。

